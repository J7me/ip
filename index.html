<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Мой IP и локация</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 100vh;
    }
    h1 { color: #0088cc; margin-bottom: 10px; }
    #result {
      font-size: 1.1em;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 360px;
      text-align: left;
    }
    #result strong { color: #006699; }
    #status { font-size: 1.1em; color: #555; margin-top: 10px; }
    .error { color: #d32f2f; }
    .success { color: #2e7d32; }
  </style>
</head>
<body>

  <h1>Твой IP и локация</h1>
  <div id="result">Получаем данные...</div>
  <div id="status">Подождите секунду...</div>

  <script>
    async function fetchLocation() {
      const resultEl = document.getElementById('result');
      const statusEl = document.getElementById('status');

      const apis = [
        'https://ipapi.co/json',                  // надёжный, CORS ok
        'https://ip-api.com/json',                // очень быстрый
        'https://api.ipify.org?format=json',      // только IP, но супер-надёжный
      ];

      for (const url of apis) {
        try {
          statusEl.textContent = `Пробуем ${new URL(url).hostname}...`;

          const res = await Promise.race([
            fetch(url, { cache: 'no-store' }),
            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 8000)) // 8 сек таймаут
          ]);

          if (!res.ok) continue;

          const data = await res.json();

          let output = '';
          if (data.ip) output += `<strong>IP:</strong> ${data.ip}<br>`;
          if (data.city) output += `<strong>Город:</strong> ${data.city}<br>`;
          if (data.region || data.regionName) output += `<strong>Регион:</strong> ${data.region || data.regionName}<br>`;
          if (data.country || data.country_name) output += `<strong>Страна:</strong> ${data.country || data.country_name} (${data.countryCode || data.country_code || '—'})<br>`;
          if (data.lat && data.lon) output += `<strong>Координаты:</strong> ${data.lat}, ${data.lon}<br>`;
          if (data.timezone) output += `<strong>Часовой пояс:</strong> ${data.timezone}<br>`;
          if (data.org || data.isp) output += `<strong>Провайдер:</strong> ${data.org || data.isp || data.as || '—'}<br>`;

          if (output) {
            resultEl.innerHTML = output || 'Данные получены, но пусто';
            statusEl.textContent = 'Готово ✓';
            statusEl.classList.add('success');

            // Отправка в бот (расширенный payload)
            const payload = {
              web_app_ip: data.ip,
              city: data.city || data.cityName,
              region: data.region || data.regionName,
              country: data.country || data.country_name,
              country_code: data.countryCode || data.country_code,
              loc: data.lat && data.lon ? `${data.lat},${data.lon}` : null,
              timezone: data.timezone,
              org: data.org || data.isp || data.as
            };
            Telegram.WebApp.sendData(JSON.stringify(payload));
            setTimeout(() => Telegram.WebApp.close(), 4000);
            return; // успех — выходим
          }
        } catch (err) {
          console.error(`Ошибка на ${url}:`, err);
        }
      }

      // Если все API провалились
      resultEl.innerHTML = 'Не удалось получить данные :(';
      resultEl.classList.add('error');
      statusEl.textContent = 'Проверь интернет или попробуй позже';
      statusEl.classList.add('error');
      Telegram.WebApp.sendData(JSON.stringify({ error: 'Все API не ответили' }));
    }

    function init() {
      if (window.Telegram?.WebApp?.ready) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        fetchLocation();
      } else {
        setTimeout(init, 400);
      }
    }

    window.addEventListener('load', init);
  </script>

</body>
</html>
